#!/bin/bash
source helpers

load_options $@

log info "starting setup"

if [[ ${options[skip-fonts]} != true ]]; then
   log info "installing fonts"

   fonts_paths="$HOME/.local/share/fonts"
   mkdir -p $fonts_paths

   for font in ./fonts/*.ttf
   do
      log action "installing font $font"

      cp $font $fonts_paths
   done

   log action "restarting fonts cache"

   fc-cache -f -v > /dev/null
else
   log info "skip fonts install"
fi

if [[ ${options[skip-dependencies]} != true ]]; then
   log info "installing dependencies"

   declare -A dependencies=( 
      ["asdf"]="./installs/asdf"
      ["homebrew"]="./installs/brew"
      ["code"]="./installs/code"
      ["code-extensions"]="./installs/code-extensions"
      ["zsh"]="./installs/zsh"
      ["pnpm"]="./installs/pnpm"
      ["node"]="./installs/node"
      ["dconf"]="./installs/dconf"
      ["gnome-terminal-profile"]="./installs/gnome-terminal-profile"
      ["z-jump-around"]="./installs/z-jump-around"
   );
   declare -a deps_orders;

   deps_orders+=( "homebrew" )
   deps_orders+=( "asdf" )
   deps_orders+=( "code" )
   deps_orders+=( "code-extensions" )
   # deps_orders+=( "zsh" )
   deps_orders+=( "pnpm" )
   deps_orders+=( "node" )
   deps_orders+=( "dconf" )
   deps_orders+=( "gnome-terminal-profile" )

   for dep in "${deps_orders[@]}"; do 
      log info "trying to install $dep"

      exists=$(which $dep)
      check_install_exit=$?

      if [ $check_install_exit -ne 0 ] ;then
         log action "running ${dependencies[$dep]} script"

         ${dependencies[$dep]}
      else
         log error "$dep already registered; skipping";
      fi
   done
else
   log info "skip dependencies install"
fi

if [[ ${options[skip-settings]} != true ]]; then
   declare -A settings=( 
      ["vscode-settings.json"]="$HOME/.config/Code/User/settings.json"
      ["keybindings.json"]="$HOME/.config/Code/User/keybindings.json"
      [".zshrc"]="$HOME/.zshrc" 
      [".gitconfig"]="$HOME/.gitconfig"
      ["bash-commands"]="/usr/bin/peam-commands"
   )

   declare -a settings_orders;

   settings_orders+=( "vscode-settings.json" )
   settings_orders+=( "keybindings.json" )
   # settings_orders+=( ".zshrc" )
   settings_orders+=( "bash-commands" )

   sudo sleep 0; # just for grab previous permissions

   for setting_file in "${settings_orders[@]}"; do 
      log action "installing setting $setting_file"

      sudo cp settings/$setting_file ${settings[$setting_file]}
   done
else
   log info "skip settings install"
fi

if [[ ${options[skip-sources]} != true ]]; then
   if ! has_installed_sources_before; then
      log action "adding sources to bash config file"
      cat sources >> "$HOME/.bashrc"
   else
      log info "skip bash sources"
   fi
else
   log info "skip bash sources"
fi
